default_prompt: |
  Analyze photo. Return ONLY valid JSON, no text/comments/fences. Keys in exact order shown. Numbers as integers without units.
  
  If NOT food/drink: {"error": "NOT A FOOD"}
  
  CRITICAL RULES:
  1. Use SINGULAR form for ALL dish names (Apple not Apples, Date not Dates, Fry not Fries)
  2. Rating = product quality ONLY, NOT quantity (1 apple = 5 apples = same rating)
  3. Check MANDATORY REFERENCE RATINGS table first - if product listed, USE THAT EXACT RATING
  
  If food/drink (including packaged items):
  {"type":"food_processing","dish_name":"<name>","estimated_avg_calories":<int>,"ingredients":["<item>"],"total_avg_weight":<int>,"health_rating":<int>,"food_health_level":{"title":"<4 words max + emoji>","description":"<20 words max>","health_summary":[{"ingredients":"<name + emoji>","description":"<10 words max>","risk":"<5 words, if harmful>","benefit":"<5 words, if healthy>"}]},"contains":{"proteins":<int>,"fats":<int>,"carbohydrates":<int>,"sugar":<int>,"is_alcohol":<bool>}}
  
  Rules:
  - FOOD NAME NORMALIZATION (CRITICAL - APPLY FIRST):
    * ALWAYS use SINGULAR form: "Date" never "Dates", "Mandarin Orange" never "Mandarins", "Walnut" never "Walnuts"
    * ALWAYS use consistent naming: "Mandarin Orange" for both small/large mandarins
    * First letter capitalized, rest lowercase unless proper noun
  - Worst-case nutrition: assume full-fat versions if unclear, all visible oil absorbed, all sauces consumed. Use realistic USDA FoodData Central or NCCDB style values.
  - Weight estimation priority: 1) visible labels, 2) reference objects (plate 28cm, fork 19cm, hand 9cm), 3) culinary standards.
  - health_rating: INTEGER 0-100. 
    ABSOLUTE RULE: RATING = FOOD QUALITY, NOT QUANTITY. 1 apple = 5 apples = 1kg apples = SAME RATING.
    1 Snickers bar = 2 Snickers bars = SAME RATING. 5 fries = 1kg fries = SAME RATING.
    STEP 1: Check MANDATORY REFERENCE RATINGS table below. If food matches (ignore singular/plural, case), USE THAT EXACT RATING. 
    STEP 2: Only if food NOT in reference table, calculate by summing points below.
    * Whole unprocessed: 0..25 (deduct up to 25 if ultra processed or packaged snack).
    * Fresh ripe raw not thermally processed: 0..20 (deduct up to 20 if cooked fried baked).
    * No added spices sauces salt sugar additives preservatives: 0..15 (deduct up to 15 if present or likely).
    * Naturally nutritious and balanced: 0..20 based on fiber vitamins minerals quality protein and fat quality.
      Add points for: fiber >= 6 per meal, high quality protein, unsaturated fats, low saturated fat.
      Deduct for: high added sugar, high saturated fat, low fiber with high calories.
    * Single or simple ingredient: 0..10 (deduct up to 10 if complex processed dish).
    * Not deep fried not ultra processed no hydrogenated fats: 0..10 (deduct up to 10 if deep fried ultra processed).
    Example: ripe fresh raw fruit with no additives should be near 100. Chips should be very low.
    HIGH RATING FOODS (95-100): Fresh berries (blueberries, strawberries, raspberries, blackberries), fresh vegetables (broccoli, spinach, kale, asparagus, bell peppers, tomatoes, carrots, cauliflower, Brussels sprouts), fresh fruits (apples, avocados, oranges, grapes, kiwi, lemons, mangoes), raw nuts and seeds (almonds, walnuts, chia seeds, macadamia), fresh fish (salmon, sardines, trout, tuna), fresh lean meats (chicken breast, lean beef, lamb), eggs, legumes (lentils, beans), whole grains (brown rice, oats, quinoa), olive oil, garlic, onions.
    MANDATORY REFERENCE RATINGS (USE EXACTLY THESE VALUES - NO VARIATION ALLOWED):
    BEFORE CALCULATING: CHECK IF FOOD IS IN THIS LIST. IF YES, USE THIS EXACT RATING.
    Fruits (Fresh):
    * Spinach: 100
    * Blueberry/Raspberry: 99
    * Strawberry/Avocado: 98
    * Apple/Orange/Mandarin Orange/Lime/Lemon: 97
    * Carrot/Kiwi: 96
    * Pear/Salmon: 95
    * Peach: 94
    * Plum: 93
    * Grape/Egg: 92
    * Mango: 92
    * Banana/Almond: 90
    * Walnut/Oatmeal: 88
    * Date: 78 (dried, high sugar)
    Vegetables & Proteins:
    * Broccoli: 99
    * Tomato: 98
    * Chicken Breast (grilled): 85
    * Potato (boiled): 75
    Processed Foods (always low):
    * French Fries: 25 (deep fried, high fat)
    * Chips/Crisps: 18 (ultra processed)
    * Snickers Bar: 22 (high sugar, processed)
    * Coca Cola: 15 (pure sugar drink)
    * Pizza (takeaway): 35 (processed, high fat)
    * White Bread: 45 (refined carbs)
    * Brown Rice: 80
    * Whole Grain Bread: 72
  - health_summary = PRODUCT COMPOSITION. List the main ingredients/components of the dish. Each entry = one ingredient or component with ONE benefit OR ONE risk (never both in one entry). Use 1-2 entries per ingredient max. Include vitamins and minerals in the description when the ingredient contains them (e.g. seafood ‚Äî protein, minerals; eggs ‚Äî protein, B12; fruits/vegetables/berries ‚Äî name the vitamins: C, A, K, folate, etc.).
  - health_summary SORTING (STRICT): Good first, bad last. Put ALL entries with impact="Benefit" at the TOP (good points), then ALL entries with impact="Risk" at the BOTTOM (bad points). User must see positives first, then negatives.
  - FRUITS, VEGETABLES, BERRIES: In description and health_summary benefits, always mention the main vitamins (e.g. vitamin C, A, K, folate, B6, E). Example: orange ‚Äî "Vitamin C, folate"; carrot ‚Äî "Vitamin A (beta-carotene)"; spinach ‚Äî "Vitamins K, A, folate"; blueberry ‚Äî "Vitamin C, K, antioxidants". Keep within max word limits.
  - Text fields restriction:
    * dish_name and ingredients must be alphanumeric plus spaces only, first letter capitalized.
    * food_health_level title and health_summary ingredient may include emojis.
    * descriptions must be max length as specified.
  - is_alcohol: true for alcoholic drinks.
  - COFFEE: Track coffee consumption. If consumed 2+ times daily, flag for warning in recommendations.
  - MULTIPLE ITEMS ON PHOTO: If photo shows two or more different foods (e.g. banana and mandarin), take each item's rating from the reference table, then health_rating = average of these ratings rounded UP (ceiling). Example: banana 90 + mandarin 95 ‚Üí (90+95)/2 = 92.5 ‚Üí health_rating = 93. Do NOT use only the lowest rating.
  - CONSISTENCY RULE (ABSOLUTE - NO EXCEPTIONS):
    * ONE PRODUCT = ONE RATING, regardless of quantity, weight, or word form
    * Examples: Apple/Apples, 1 apple/5 apples, Date/Dates, Snickers/2 Snickers, French Fries 50g/1kg ‚Üí SAME RATING
    * Rating depends ONLY on: freshness, processing level, additives. NOT on portion size.
    * Always use SINGULAR form in dish_name: "Apple" not "Apples", "Date" not "Dates"
    * Process: 1) Identify product 2) Normalize to singular 3) Check reference table 4) Use exact rating
    * Reference table ratings are MANDATORY - do not recalculate, just copy the value.
  - TEA/COFFEE SUGAR RULE: Plain tea or coffee contains ZERO sugar unless packaging shows added sweeteners (Lipton Iced Tea, Arizona Tea, Starbucks bottled drinks). Black tea, green tea, coffee beans have 0g sugar. Only add sugar if visible evidence on label or if user explicitly added sugar/milk to drink.

  If food or drink (including packaged items) return:
  {"type":"food_processing",
   "dish_name":"<Name>",
   "estimated_avg_calories":<int>,
   "ingredients":["<Item>"],
   "total_avg_weight":<int>,
   "health_rating":<int>,
   "food_health_level":{
     "title":"<Max 4 words + emoji>",
     "description":"<Max 20 words>",
     "health_summary":[
       {"ingredient":"<Name + emoji>",
        "description":"<Max 10 words>",
        "impact":"Benefit",
        "impact_text":"<Max 5 words + emoji optional>"},
       {"ingredient":"<Name + emoji>",
        "description":"<Max 10 words>",
        "impact":"Risk",
        "impact_text":"<Max 5 words + emoji optional>"}
     ]
   },
   "contains":{
     "proteins":<int>,
     "fats":<int>,
     "carbohydrates":<int>,
     "sugar":<int>,
     "fiber":<int>,
     "saturated_fat":<int>,
     "sodium":<int>,
     "is_alcohol":<bool>
   }
  }

  Notes:
  - Use worst-case assumptions for oils sauces dressings and toppings.
  - Make dish_name and ingredients simple and recognizable.
  - If unsure about an ingredient, include it with lower confidence in description text, not extra JSON keys.
  - health_summary = composition of the dish: one entry per main component (e.g. for "Crab salad" ‚Üí Crab: benefit (protein, minerals); Mayo: risk (fat, sodium)). Order: ALL benefits first, then ALL risks. 1-2 points per component. Add vitamins/minerals in benefit text when present.
  - CRITICAL SORTING: In health_summary array, ALWAYS put all Benefit items first, followed by all Risk items. Never mix them.

weight_prompt: |
  Extract weight from scale OCR text. JSON only, no extra text.
  - Normalize separators to dot. If missing, last digit is decimal.
  - Valid range: 30-150 kg.
  - Output: {"type":"weight_processing","weight":<number>} or {"error":"INVALID_WEIGHT"}

get_recommendation: |
  JSON only. Analyze food history and provide concise recommendations. Return exactly this structure:
  {
    "foods_to_reduce_or_avoid": [{"dish_name": "<translated>", "reason": "<concise reason, 4-6 words, 1 emoji max>"}],
    "foods_to_reduce_title_color": "red",
    "healthier_foods": [{"dish_name": "<translated>", "reason": "<concise reason, 4-6 words, 1 emoji max>"}],
    "healthier_foods_title_color": "green",
    "general_recommendations": {"<key>": "<brief advice, 3-6 words, 1 emoji max>"},
    "favorite_dish": {"dish_name": "<translated>", "description": "<4-6 words, 1 emoji max>"},
    "recommended_dish": {"cuisine": "<cuisine name>", "dish": "<specific dish name translated>", "description": "<3-5 words>"} OR empty object {},
    "age_based_health_advice": "<targeted advice based on user age, 8-12 words, 1 emoji>",
    "coffee_warning": "<if >=3 coffees/day: max 10 words, 1 emoji, else empty string>",
    "weekly_sugar_summary": "<total added sugar in grams (teaspoons), warning if >175g/week, else congratulations, 10-15 words, 1 emoji>",
    "translation_keys": {"foods_to_reduce_or_avoid": "<translated>", "healthier_foods": "<translated>", "general_recommendations": "<translated>", "favorite_dish": "<translated>", "recommended_dish": "<translated>", "age_based_health_advice": "<translated>", "coffee_warning": "<translated>", "weekly_sugar_summary": "<translated>"}
  }
  
  CRITICAL: Keys must stay in English. NEVER translate keys. Translate ONLY values to respond_in_language.
  BREVITY RULES:
  - Maximum 1 emoji per item. No emoji chains.
  - reason: 4-6 words max (e.g., "High sugar, try less üç¨")
  - general_recommendations: 3-6 words per advice
  - 3 items each for foods_to_reduce_or_avoid and healthier_foods
  - 3 key:value pairs for general_recommendations
  - favorite_dish: most eaten healthy dish, 4-6 words
  - recommended_dish: ONLY recommend if dish has health_rating 80+. Pick ONE specific dish from cuisines (Italian: Risotto/Pasta Carbonara, French: Ratatouille/Nicoise Salad, Japanese: Miso Salmon/Sushi, Mediterranean: Greek Salad/Hummus Bowl, Asian: Stir-fry/Pho, Mexican: Fish Tacos/Guacamole). If no dish with rating 80+, return empty object {}.
  SPECIAL RULES:
  - COFFEE WARNING: Show ONLY if >=3 coffees per day (3 or more). Max 10 words. Example: "Too much caffeine, reduce intake ‚òï"
  - AGE_BASED_HEALTH_ADVICE: Provide ONE general health advice (8-12 words, 1 emoji) based on evidence from NHS and longevity research. Rotate through these evidence-based tips:
    * Build peak fitness with regular strength training twice weekly üí™
    * Maintain consistent sleep schedule for better metabolism üò¥
    * Do 150min moderate or 75min vigorous activity weekly üö¥
    * Include balance and flexibility exercises daily üßò
    * Limit alcohol and prioritize hydration throughout day üíß
    * Focus on whole foods and reduce ultra-processed items ü•ó
  - Use varied advice each time, not always the same tip
  - WEEKLY SUGAR SUMMARY: Calculate total FREE SUGARS from last 7 days (WHO definition):
    * Include: manually added sugar (added_sugar_tsp √ó 5g) + sugar from processed foods (candy, sodas, juice, desserts) + sugar from packaged items
    * Exclude: natural sugar from fresh fruits, vegetables, plain milk
    * Format: "Xg (Y tsp) free sugars this week" where Y = X/5 rounded to 1 decimal
    * ALWAYS show if >0g
    * If >175g (WHO limit 25g/day √ó 7): "‚ö†Ô∏è Exceeds WHO recommendation"
    * If 100-175g: "Moderate, try to reduce üç¨"
    * If <100g: "Good control! üëç"
    * Max 15 words total
    * Data source: WHO guidelines on free sugars (https://www.who.int/news-room/fact-sheets/detail/healthy-diet)

respond_in_language: |
  Target language from "respond_in_language" (ISO 639-1). Default: en.
  - JSON keys: English
  - ALL values: target language only (dish names, reasons, recommendations)
  - Include translation_keys mapping

get_recommendation_local: |
  JSON only. One top-level object starting with "{".
  TARGET LANGUAGE from respond_in_language (ISO 639-1). Default: en.
  TRANSLATE keys AND values.
  
  Exactly 3 keys in order:
  1) <reduce_key_translated>: ["Dish: reason", "Dish: reason", "Dish: reason"]
  2) <healthier_key_translated>: ["Dish: reason", "Dish: reason", "Dish: reason"]
  3) <recs_key_translated>: ["recommendation", "recommendation", "recommendation"] (3-6 words each)
  
  - Dish names from Food Table only, translated. No generic words.
  - Arrays contain strings only, not objects.
  - No extra keys, no markdown, no trailing text.
  - Keep text concise: 3-6 words per recommendation, max 1 emoji per item.–ø—à–µ 